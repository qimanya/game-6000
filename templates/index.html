<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Title IX Educational Card Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
        }
        
        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }

        .role-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 18px 24px;
            min-width: 260px;
            max-width: 350px;
            z-index: 10;
            font-size: 15px;
        }

        .role-info h3 {
            margin: 0 0 8px 0;
            font-size: 20px;
            color: #2196F3;
        }

        .role-info ul {
            margin: 8px 0 0 18px;
            padding: 0;
        }

        .role-info li {
            margin-bottom: 4px;
        }

        .waiting-screen {
            text-align: center;
            padding: 40px;
        }

        .player-count {
            font-size: 24px;
            margin: 20px 0;
        }

        .game-area {
            display: none;
        }

        .crisis-area {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .crisis-card {
            width: 200px;
            padding: 15px;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .crisis-card.level-1 { border: 3px solid #4CAF50; }
        .crisis-card.level-2 { border: 3px solid #FFC107; }
        .crisis-card.level-3 { border: 3px solid #F44336; }

        .hand-area {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .action-card {
            width: 150px;
            padding: 10px;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .action-card:hover {
            transform: translateY(-5px);
        }

        .pressure-track {
            height: 30px;
            background: linear-gradient(to right, #4CAF50, #FFC107, #F44336);
            border-radius: 15px;
            margin: 20px 0;
            position: relative;
        }

        .pressure-marker {
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            position: absolute;
            top: 5px;
            left: 0;
            transition: left 0.3s;
        }

        .player-info {
            margin: 20px 0;
            padding: 10px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }

        .player-info.current {
            background-color: #e8f5e9;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div id="roleInfo" class="role-info" style="display:none;"></div>
        <h1>Title IX Educational Card Game</h1>
        
        <div id="waitingScreen" class="waiting-screen">
            <h2>Waiting for other players to join...</h2>
            <div class="player-count">
                Current players: <span id="playerCount">0</span>/3
            </div>
        </div>

        <div id="gameArea" class="game-area">
            <div id="playerInfo" class="player-info"></div>

            <div class="pressure-track">
                <div class="pressure-marker" id="pressureMarker"></div>
            </div>
            <div id="pressureStatus"></div>

            <div class="crisis-area" id="crisisArea"></div>

            <div class="hand-area" id="handArea"></div>
        </div>
    </div>

    <script>
        const socket = io({
            transports: ['websocket'],
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000
        });
        let currentPlayerId = null;
        let currentRole = null;
        let roleInfoShown = false;
        const roleDescriptions = {
            'Student': {
                title: 'Student',
                desc: 'You can see the crisis from the "student perspective" and can only play support cards. Communication with teachers and guards is crucial to understand the full picture of each crisis.',
                abilities: [
                    'Can only play support cards',
                    'Crisis description from student perspective',
                    'Goal: Collaborate with teachers and guards to resolve crises and prevent system collapse',
                    'Tip: Share your perspective with others to help them understand the student experience'
                ]
            },
            'Teacher': {
                title: 'Teacher',
                desc: 'You can see the crisis from the "teacher perspective" and can only play policy cards. Understanding both student and guard perspectives will help you make better policy decisions.',
                abilities: [
                    'Can only play policy cards',
                    'Crisis description from teacher perspective',
                    'Goal: Collaborate with students and guards to resolve crises and prevent system collapse',
                    'Tip: Listen to students and guards to make informed policy decisions'
                ]
            },
            'Guard': {
                title: 'Guard',
                desc: 'You can see the crisis from the "guard perspective" and can only play support cards. Your role is vital in maintaining campus safety while understanding both student and teacher concerns.',
                abilities: [
                    'Can only play support cards',
                    'Crisis description from guard perspective',
                    'Goal: Collaborate with teachers and students to resolve crises and prevent system collapse',
                    'Tip: Bridge the gap between students and teachers by sharing security insights'
                ]
            }
        };

        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('player_connected', (data) => {
            if (data.player_id) {
                currentPlayerId = data.player_id;
            }
            document.getElementById('playerCount').textContent = data.total_players;
        });

        socket.on('game_state', (state) => {
            if (state.started) {
                document.getElementById('waitingScreen').style.display = 'none';
                document.getElementById('gameArea').style.display = 'block';
                updateGameDisplay(state);
                // 首次分配角色后弹出角色说明
                const me = state.players.find(p => p.id === currentPlayerId);
                if (me && me.role && (!roleInfoShown || currentRole !== me.role)) {
                    showRoleInfo(me.role);
                    currentRole = me.role;
                    roleInfoShown = true;
                }
                // 游戏失败弹窗
                if (state.failed) {
                    setTimeout(() => {
                        alert('System collapse! Game failed!');
                        // 禁用所有操作
                        document.getElementById('handArea').style.pointerEvents = 'none';
                        document.getElementById('handArea').style.opacity = 0.5;
                    }, 100);
                }
            }
        });

        function showRoleInfo(role) {
            const info = roleDescriptions[role];
            if (!info) return;
            const roleDiv = document.getElementById('roleInfo');
            roleDiv.innerHTML = `<h3>${info.title}</h3><div>${info.desc}</div><ul>${info.abilities.map(r=>`<li>${r}</li>`).join('')}</ul>`;
            roleDiv.style.display = 'block';
        }

        function updateGameDisplay(state) {
            // 玩家信息
            const playerInfo = document.getElementById('playerInfo');
            playerInfo.innerHTML = '';
            let myRole = '';
            let hasPlayed = false;
            state.players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = `player-info ${player.id === currentPlayerId ? 'current' : ''}`;
                if (player.id === currentPlayerId) {
                    playerDiv.innerHTML = `<strong>${player.role}</strong> <span>Hand: ${player.hand.length}</span>`;
                    myRole = player.role;
                    hasPlayed = player.has_played_this_turn;
                } else {
                    playerDiv.innerHTML = `<strong>${player.role}</strong> <span>Hand: ${player.hand_count || 0}</span>`;
                }
                playerInfo.appendChild(playerDiv);
            });
            // 压力值
            const pressurePercent = (state.pressure / state.max_pressure) * 100;
            document.getElementById('pressureMarker').style.left = `${pressurePercent}%`;
            document.getElementById('pressureStatus').textContent = `Pressure: ${state.pressure}/${state.max_pressure}`;
            // 危机卡牌
            const crisisArea = document.getElementById('crisisArea');
            crisisArea.innerHTML = '';
            state.active_crises.forEach(crisis => {
                const card = document.createElement('div');
                card.className = `crisis-card level-${crisis.level}`;
                // 格式化需求
                let needsText = '';
                if (crisis.needs) {
                    const needsArr = [];
                    if (crisis.needs.support) needsArr.push(`Support needed`);
                    if (crisis.needs.policy) needsArr.push(`Policy needed`);
                    needsText = needsArr.join('，');
                }
                // 三栏内容
                card.innerHTML = `
                    <h3>${crisis.title}</h3>
                    <div><b>Teacher visible:</b>${crisis.desc_for_teacher}</div>
                    <div><b>Student visible:</b>${crisis.desc_for_student}</div>
                    <div><b>Guard visible:</b>${crisis.desc_for_guard}</div>
                    <p>${needsText}</p>
                `;
                crisisArea.appendChild(card);
            });
            // 手牌（只显示自己手牌）
            const handArea = document.getElementById('handArea');
            handArea.innerHTML = '';
            const me = state.players.find(p => p.id === currentPlayerId);
            if (me && me.hand) {
                me.hand.forEach((card, index) => {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'action-card';
                    cardElement.innerHTML = `
                        <h4>${card.title}</h4>
                        <p>${card.effect}</p>
                    `;
                    cardElement.onclick = () => {
                        if (!hasPlayed && !state.failed) playCard(index);
                    };
                    if (hasPlayed || state.failed) {
                        cardElement.style.opacity = 0.5;
                        cardElement.style.pointerEvents = 'none';
                    }
                    handArea.appendChild(cardElement);
                });
            }
        }

        function playCard(cardIndex) {
            socket.emit('play_card', {
                player_id: currentPlayerId,
                card_index: cardIndex
            });
        }
    </script>
</body>
</html> 